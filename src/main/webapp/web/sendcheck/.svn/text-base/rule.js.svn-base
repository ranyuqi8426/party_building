Ext.onReady(function() {
	var addOrUpdate = 0;// 定义新增还是修改的标示
	// 积分状态
	function ruleStatus(val) {
		if (val == "01")
			return '注册';
		else if (val == "02")
			return '绑卡';
		else if (val == "03")
			return '实名认证';
		else if (val == "04")
			return '充值';
		else if (val == "05")
			return '支付';
		else
			return "";

	}
	// 积分类型
	function ruleType(val) {
		if (val == "01")
			return '固定积分';
		else if (val == "02")
			return '按金额比例';
		else
			return "";

	}
	// 积分渠道
	var statusStore = Ext.create('Ext.data.Store', {
		model : 'ComboboxData',
		data : [ {
			'value' : '01',
			'content' : '注册'
		}, {
			'value' : '02',
			'content' : '绑卡'
		}, {
			'value' : '03',
			'content' : '实名认证'
		}, {
			'value' : '04',
			'content' : '充值'
		}, {
			'value' : '05',
			'content' : '支付'
		} ]
	})
	// 积分类型
	var typeStore = Ext.create('Ext.data.Store', {
		model : 'ComboboxData',
		data : [ {
			'value' : '01',
			'content' : '固定积分'
		}, {
			'value' : '02',
			'content' : '按金额比例'
		} ]
	})
	Ext.define('PointRule', {
		extend : 'Ext.data.Model',
		fields : [ {
			name : 'rule_id',
			type : 'string'
		}, {
			name : 'rule_channel',
			type : 'string'
		}, {
			name : 'rule_type',
			type : 'string'
		}, {
			name : 'rule_amount',
			type : 'string'
		}, {
			name : 'rule_rate',
			type : 'string'
		}, {
			name : 'rule_remark',
			type : 'string'
		} ]
	});

	var ruleStore = Ext.create('Ext.data.Store', {
		model : 'PointRule',
		pageSize : pagelimit,
		proxy : {
			type : 'ajax',
			url : basePath + '/point/rule/search.do',
			actionMethods : {
				read : "POST"
			},
			reader : {
				rootProperty : 'root'
			}
		},
		autoLoad : false,
		listeners : {
			beforeload : function(store) {
				Ext.apply(store.proxy.extraParams, {
					rule_channel : Ext.getCmp('cmbRule_channel').getValue(),
					rule_type : Ext.getCmp('cmbRule_type').getValue(),
				});
			}
		}
	});

	var selRuleModel = Ext.create('Ext.selection.CheckboxModel', {
		mode : 'SINGLE'
	});

	var ruleTb = Ext.create('Ext.toolbar.Toolbar', {
		layout : {
			overflowHandler : 'Menu'
		},
		items : [ {
			text : '新增',
			glyph : glyphAdd,
			handler : addRule
		}, '积分渠道', {
			id : 'cmbRule_channel',
			xtype : 'combobox',
			valueField : 'value',
			displayField : 'content',
			store : statusStore,
			queryMode : 'local',
			width : 150,
			typeAhead : true,
			editable : false
		}, '积分类型', {
			id : 'cmbRule_type',
			xtype : 'combobox',
			valueField : 'value',
			displayField : 'content',
			store : typeStore,
			queryMode : 'local',
			width : 150,
			typeAhead : true,
			editable : false
		}, {
			xtype : 'button',
			glyph : glyphSearch,
			text : '查询',
			handler : function() {
				searchRule();
			}
		}, {
			xtype : 'button',
			glyph : glyphClear,
			text : '清空',
			handler : function() {
				clearRule();
			}
		} ]
	});

	var ruleGrid = Ext.create('Ext.grid.Panel', {
		title : '积分规则表列表',
		frame : true,
		glyph : glyphGrid,
		width : '100%',
		height : pageH,
		collapsible : true,// 表头缩回按钮
		store : ruleStore,
		selModel : selRuleModel,
		renderTo : Ext.getBody(),
		columns : [ {
			xtype : 'rownumberer',
			width : 40
		}, {
			text : '积分渠道',
			dataIndex : 'rule_channel',
			width : 100,
			align : 'center',
			sortable : false,
			renderer : ruleStatus
		}, {
			text : '积分类型',
			dataIndex : 'rule_type',
			width : 100,
			align : 'center',
			sortable : false,
			renderer : ruleType
		}, {
			text : '积分额度',
			dataIndex : 'rule_amount',
			width : 100,
			align : 'left',
			sortable : false
		}, {
			text : '积分比例',
			dataIndex : 'rule_rate',
			width : 100,
			align : 'left',
			sortable : false
		}, {
			text : '说明',
			dataIndex : 'rule_remark',
			width : 180,
			align : 'left',
			sortable : false
		}, {
			xtype : 'actioncolumn',
			text : '操作',
			width : 120,
			align : 'left',
			items : [ {
				text : '修改',
				handler : function(grid, rowIndex, colIndex) {
					setGridSelect(grid, rowIndex);
					updateRule(grid.getStore().getAt(rowIndex));
				}
			}, {
				text : '删除',
				handler : function(grid, rowIndex, colIndex) {
					setGridSelect(grid, rowIndex);
					deleteRule(grid.getStore().getAt(rowIndex))
				}
			}, {
				text : '查看',
				handler : function(grid, rowIndex, colIndex) {
					setGridSelect(grid, rowIndex);
					viewRule(grid.getStore().getAt(rowIndex))
				}
			} ]
		} ],
		viewConfig : {
			stripeRows : true,
			enableTextSelection : true
		},
		tbar : ruleTb,
		bbar : Ext.create('Ext.PagingToolbar', {
			store : ruleStore,
			displayInfo : true
		})
	});
	var ruleForm = new Ext.create("Ext.form.Panel", {
		id : 'ruleForm',
		frame : true,
		border : true,
		width : '100%',
		height : 220,
		bodyPadding : 4,
		layout : 'column',
		buttonAlign : 'center',
		defaultType : 'textfield',
		waitTitle : '正在提交中',
		fieldDefaults : {
			labelAlign : 'right',
			labelWidth : 120,
			anchor : '100%',
			margin : '0 0 5 0',
			msgTarget : 'qtip',
			columnWidth : 1
		},
		items : [ {
			name : 'rule_id',
			hidden : true
		}, {
			name : 'rule_channel',
			fieldLabel : '积分渠道',
			allowBlank : false,
			xtype : 'combobox',
			valueField : 'value',
			displayField : 'content',
			store : statusStore,
			width : 300,
			multiSelect : false,
			queryMode : 'local',
			typeAhead : true,
			editable : false
		}, {			
			name : 'rule_type',
			fieldLabel : '积分类型',
			allowBlank : false,
			xtype : 'combobox',
			valueField : 'value',
			displayField : 'content',
			store : typeStore,
			width : 300,
			multiSelect : false,
			queryMode : 'local',
			typeAhead : true,
			editable : false
		}, {
			fieldLabel : '积分额度',
			xtype : 'textfield',
			width : 100,
			name : 'rule_amount',
			maxLength : 10
		}, {
			fieldLabel : '积分比例',
			xtype : 'textfield',
			width : 100,
			name : 'rule_rate',
			maxLength : 10
		}, {
			fieldLabel : '说明',
			xtype : 'textfield',
			width : 100,
			name : 'rule_remark',
			maxLength : 200
		} ],
		buttons : [ {
			text : '保存',
			glyph : glyphSave,
			handler : saveRule
		}, {
			text : '返回',
			glyph : glyphBack,
			handler : function() {
				ruleWin.hide();
			}
		} ]
	});

	var ruleWin = new Ext.Window({
		width : 500,
		height : 260,
		glyph : glyphWindow,
		title : '新增/修改',
		modal : true,
		closeAction : 'hide',
		padding : 4,
		items : [ ruleForm ]
	});

	var ruleViewForm = new Ext.create("Ext.form.Panel", {
		id : 'ruleViewForm',
		width : '100%',
		height : 280,
		bodyPadding : 4,
		layout : 'column',
		defaultType : 'textfield',
		buttonAlign : 'center',
		fieldDefaults : {
			labelAlign : 'right',
			labelWidth : 90,
			anchor : '100%',
			margin : '0 0 5 0',
			msgTarget : 'qtip',
			columnWidth : 1
		},
		items : [ {
			fieldLabel : '积分渠道',	
			name : 'rule_channel',
			renderer : ruleStatus
		}, {
			fieldLabel : '积分类型',
			name : 'rule_type',
			renderer : ruleType
		}, {
			fieldLabel : '积分额度',
			name : 'rule_amount'
		}, {
			fieldLabel : '积分比例',
			name : 'rule_rate'
		}, {
			fieldLabel : '说明',
			name : 'rule_remark'
		} ],
		buttons : [ {
			text : '返回',
			glyph : glyphBack,
			handler : function() {
				ruleViewWin.hide();
			}
		} ]
	});
	var ruleViewWin = new Ext.Window({
		width : 500,
		height : 330,
		glyph : glyphWindow,
		title : '『查看积分规则表』',
		modal : true,
		closeAction : 'hide',
		padding : 4,
		items : [ ruleViewForm ]
	});

	//searchRule();
	// 查询
	function searchRule() {
		ruleStore.loadPage(1);
	}
	// 选择性条件清空
	function clearRule() {
		Ext.getCmp('cmbRule_channel').setValue('');
		Ext.getCmp('cmbRule_type').setValue('');
	}

	// 新增
	function addRule() {
		ruleForm.getForm().reset();
		ruleForm.getForm().findField("rule_id").setValue("0");
		ruleWin.setTitle("『新增积分规则表』");
		ruleWin.show();
		addOrUpdate = 1;
	}

	// 修改
	function updateRule(record) {
		ruleForm.getForm().loadRecord(record);
		ruleWin.setTitle("『修改积分规则表』");
		ruleWin.show();
		addOrUpdate = 2;
	}

	// 保存
	function saveRule() {
		var url = "";
		if (addOrUpdate == 1)
			url = basePath + '/point/rule/add.do';
		else if (addOrUpdate == 2)
			url = basePath + '/point/rule/update.do';
		if (ruleForm.getForm().isValid()) {
			ruleForm.getForm().submit({
				clientValidation : true,
				url : url,
				success : function(form, action) {
					ruleWin.hide();
					ruleStore.reload();
				},
				failure : function(form, action) {
					Ext.Msg.alert('操作提示', action.result.msgText)
				}
			});
		}
	}

	// 删除
	function deleteRule(record) {
		Ext.Msg.confirm('确认删除', '你确定删除该条记录?', function(btn) {
			if (btn == 'yes') {
				showMask();
				Ext.Ajax.request({
					url : basePath + '/point/rule/delete.do',
					params : {
						rule_id : record.data.rule_id
					},
					success : function(response) {
						unMask();
						var result = Ext.decode(response.responseText);
						if (result.success) {
							Ext.Msg.alert('操作提示', '删除成功', function() {
								ruleStore.reload();
							});
						} else {
							Ext.Msg.alert('操作提示', result.msgText);
						}
					}
				});
			}
		});
	}

	// 查看
	function viewRule(record) {
		ruleViewForm.getForm().reset();
		ruleViewForm.getForm().loadRecord(record);
		var rule_channel="";
		if(record.get('rule_channel')=='01'){
			rule_channel="注册";
		}else if(record.get('rule_channel')=='02'){
			rule_channel="绑卡";
		}else if(record.get('rule_channel')=='03'){
			rule_channel="实名认证";
		}else if(record.get('rule_channel')=='04'){
			rule_channel="充值";
		}else if(record.get('rule_channel')=='05'){
			rule_channel="支付";
		}else{
			rule_channel="";
		}
		ruleViewForm.getForm().findField("rule_channel").setValue(rule_channel);
		var rule_type="";
		if(record.get('rule_type')=='01'){
			rule_type="固定积分";
		}else if(record.get('rule_type')=='02'){
			rule_type="按金额比例";
		}else{
			rule_type="";
		}
		ruleViewForm.getForm().findField("rule_type").setValue(rule_type);
		setFormReadOnly(ruleViewForm, true);
		ruleViewWin.show();
	}

	// 自适应大小
	Ext.GlobalEvents.on('resize', function() {
		ruleGrid.getView().refresh();
		ruleGrid.setWidth('100%')
	})
});